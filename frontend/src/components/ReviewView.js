import React, { useState } from 'react';

function ReviewView({ caseData, onSave, onBack, isSubmitting, isReadOnly }) {
  // Initialize the report text with the existing report if it's a read-only view
  const [reportText, setReportText] = useState(caseData.assessorReport || '');

  const handleSave = (status) => {
    if (status === 'Completed - Follow-up Needed' && !reportText.trim()) {
      alert('Please provide a report when flagging for follow-up.');
      return;
    }
    onSave(caseData._id, reportText, status);
  };

  const renderMLAnalysis = (mlOutput) => {
    if (!mlOutput || !mlOutput.psychIndicators || mlOutput.psychIndicators.length === 0) {
      return <p className="text-muted">No specific analysis was generated by the ML model.</p>;
    }
    const analysis = mlOutput.psychIndicators[0];
    const rawFeatures = analysis.evidence || [];

    return (
      <div>
        <h6>Raw Visual Features Detected:</h6>
        {rawFeatures.length > 0 ? (
          <p>{rawFeatures.map((feature, index) => <span key={index} className="badge bg-secondary me-2">{feature}</span>)}</p>
        ) : (<p className="text-muted">No specific visual features were identified.</p>)}
        <h6 className="mt-3">Psychological Interpretation (from AI):</h6>
        <p style={{ whiteSpace: 'pre-wrap', fontSize: '0.9em' }}>{analysis.interpretation || "No interpretation text was provided."}</p>
      </div>
    );
  };

  return (
    <div className="review-page">
      <div className="review-header">
        {/* Change title based on mode */}
        <h3>{isReadOnly ? 'View Report for' : 'Review'} {caseData.drawing.childId}</h3>
        <button className="back-button" onClick={onBack} title="Back to Dashboard">&#x2190;</button>
      </div>

      {/* ... (Image and Contextual Data cards remain the same) ... */}
       <div className="review-card">
        <h4>Child's Drawing</h4>
        <div className="drawing-placeholder">
            <a href={caseData.drawing.imageURL} target="_blank" rel="noopener noreferrer">
                <img src={caseData.drawing.imageURL} alt="Child's drawing" style={{ maxWidth: '100%', maxHeight: '300px' }} />
            </a>
            <p className="text-muted mt-2">Click image to view in full size</p>
        </div>
      </div>
      <div className="review-card ml-analysis">
        <h4>ML Descriptive Analysis</h4>
        {renderMLAnalysis(caseData.mlOutput)}
        <small className="text-muted mt-2 d-block">Note: This analysis is read-only and requires professional validation.</small>
      </div>
      <div className="review-card">
        <h4>Contextual Data</h4>
        <p><strong>Child ID:</strong> {caseData.drawing.childId}</p>
        <p><strong>Age:</strong> {caseData.drawing.childAge}</p>
        <p><strong>Notes from Teacher:</strong> {caseData.drawing.teacherNotes || 'None provided.'}</p>
      </div>

      <div className="review-card">
        <h4>Final Report & Interpretation</h4>
        <textarea
          className="final-report-textarea"
          placeholder={isReadOnly ? "No report was written for this case." : "Based on ML findings and contextual data, the assessment is..."}
          value={reportText}
          onChange={(e) => setReportText(e.target.value)}
          readOnly={isReadOnly} // Make textarea read-only
        />
      </div>

      {/* Conditionally render the action buttons */}
      {!isReadOnly && (
        <>
          <button className="btn-flag" onClick={() => handleSave('Completed - Follow-up Needed')} disabled={isSubmitting}>
            {isSubmitting ? 'Saving...' : 'Save and Flag for Follow-Up'}
          </button>
          <button className="btn-save" onClick={() => handleSave('Completed - No Concerns')} disabled={isSubmitting}>
            {isSubmitting ? 'Saving...' : 'Save (No Concerns)'}
          </button>
        </>
      )}
    </div>
  );
}

export default ReviewView;